---
import { getCollection } from "astro:content";
import Pagination from "@components/blog/pagination.astro";
import Posts from "@components/blog/posts.astro";
import Container from "@components/container.astro";
import Sectionhead from "@components/sectionhead.astro";
import Layout from "@layouts/Layout.astro";
import { getLangFromUrl } from "../../../i18n/utils";

// CRITICAL: Enable prerendering for this page
export const prerender = true;

export async function getStaticPaths({ paginate }) {
  const lang = "id";
  
  console.log('[ID PAGINATION BUILD] Starting to fetch posts...');
  
  // Get ALL blog posts first
  const allBlogPosts = await getCollection("blog");
  console.log(`[ID PAGINATION BUILD] Total posts in collection: ${allBlogPosts.length}`);
  
  // Filter for Indonesian posts
  const allPosts = allBlogPosts.filter((post) => {
    const isId = post.id.startsWith(`${lang}/`);
    const notKeep = !post.id.endsWith('keep');
    const notDraft = !post.data.draft;
    
    return isId && notKeep && notDraft;
  });

  console.log(`[ID PAGINATION BUILD] Filtered ${allPosts.length} Indonesian posts`);

  // Sort posts by date (newest first)
  allPosts.sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

  // CRITICAL FIX: Add cleanSlug property to each post
  const postsWithCleanSlugs = allPosts.map(post => {
    const cleanSlug = post.id.replace(`${lang}/`, '').replace('.md', '');
    console.log(`[ID PAGINATION BUILD] Post: ${post.id} -> cleanSlug: ${cleanSlug}`);
    
    return {
      ...post,
      slug: cleanSlug
    };
  });

  // Handle empty posts
  if (postsWithCleanSlugs.length === 0) {
    console.log('[ID PAGINATION BUILD] WARNING: No posts found!');
    return [{
      params: { page: undefined },
      props: { 
        page: {
          data: [],
          url: {
            prev: undefined,
            next: undefined,
            current: '/id/blog'
          },
          currentPage: 1,
          lastPage: 1,
          total: 0
        }
      }
    }];
  }

  console.log(`[ID PAGINATION BUILD] Creating pagination for ${postsWithCleanSlugs.length} posts`);
  return paginate(postsWithCleanSlugs, {
    pageSize: 10,
  });
}

const { page } = Astro.props;
const safeUrl = Astro.url;
const lang = getLangFromUrl(safeUrl);

// Safe access to page data with fallback
const pageData = page?.data || [];
const hasPosts = pageData.length > 0;
const prevUrl = page?.url?.prev;
const nextUrl = page?.url?.next;

console.log(`[ID PAGINATION RENDER] Page data length: ${pageData.length}`);
if (pageData.length > 0) {
  console.log(`[ID PAGINATION RENDER] First post slug: ${pageData[0].slug}`);
}
---

<Layout title="Blog">
  <Container>
    <Sectionhead>
      <Fragment slot="title">Blog Kami</Fragment>
      <Fragment slot="desc">Jelajahi wawasan industri dan pendapat ahli.</Fragment>
    </Sectionhead>
    
    {hasPosts ? (
      <>
        <Posts posts={pageData} />
        <Pagination class="mt-20" prevUrl={prevUrl} nextUrl={nextUrl} />
      </>
    ) : (
      <div class="py-20 text-center">
        <p class="text-gray-500 text-xl">Saat ini belum ada postingan.</p>
        <p class="text-gray-400 mt-4">Silakan kembali lagi nanti atau periksa bagian lain.</p>
        <a 
          href="/id/" 
          class="inline-block mt-6 px-6 py-3 text-base font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors duration-200"
        >
          Kembali ke beranda
        </a>
      </div>
    )}
  </Container>
</Layout>